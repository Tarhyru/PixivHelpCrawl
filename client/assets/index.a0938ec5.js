import{r as S,o as z,F as J,j as A}from"./react-venders.669d625f.js";import"./index.c8ca1af3.js";import{B as b}from"./button.ce6ccd71.js";const p={"unexpected-state":!0,"timed-out":!0,unlocked:!0};function G({storage:r=window.localStorage,outerPrefix:l="_MUT_OUT_LOCK_",innerPrefix:s="_MUT_IN_LOCK_",tick:i=20,memorySafe:m=!0,lockTimeout:f=2e3,clientId:c=H(),crossTabDebugger:g=Q()}){a("clientId",c);const d=new Map;let w=0,y,U=!1;g.onexit=function(){clearTimeout(y),U=!0,a("exited")},g.clientId=c;function T(e){r.removeItem(e)}function O(e,n){r.setItem(e,JSON.stringify({expiresAt:new Date().getTime()+f,value:n}))}function _(e){const n=r.getItem(e);if(!n)return null;const t=JSON.parse(n);return new Date().getTime()-t.expiresAt>=f?(g.expiring(n),null):t.value}function L(){const e=new Date().getTime();for(const[n,t]of d)v(t,e),t.lockRequests.length===0&&d.delete(n);d.size&&(y=setTimeout(L,i))}function v(e,n){let t;for(;t=e.lockRequests[0];){let o=M(t,n);if(p[o]===!0)e.lockRequests.shift();else break}}function M(e,n){if(!(e.waitUntil&&n<e.waitUntil))if(e.state==="requested"||e.state==="set-outer"){O(e.outerKey,e.id);let t=_(e.innerKey);t&&t!==e.id?N(e,n,t):(O(e.innerKey,e.id),e.state="set-inner",a(e.id,"set innerKey. InnerKey was",t))}else if(e.state==="set-inner"){let t=_(e.outerKey);if(t!==e.id)j(e,n,t);else{const o=D(e),K=F(e),x=P(e);o.then(K,x)}}else e.state==="locked"?O(e.innerKey,e.id):p[e.state]===!0||(a(e.id,"unexpected-state",e.state),e.reject(new Error(`Unexpected state ${e.state}`)),e.state="unexpected-state");return e.state}function j(e,n,t){if(e.outerKeyAlreadyOwned++,e.state="requested",e.outerKeyAlreadyOwned>1){const o=Math.random()*e.outerKeyAlreadyOwned;a(e.id,"outerKeyAlreadyOwned backing off. Owned by",t),e.waitUntil=n+i*o}else a(e.id,"outerKeyAlreadyOwned. Owned by",t)}function N(e,n,t){if(e.state="set-outer",e.innerKeyAlreadyOwned++,e.innerKeyAlreadyOwned>1){const o=Math.random()*e.innerKeyAlreadyOwned;a(e.id,"innerKeyAlreadyOwned backing off. Owned by",t),e.waitUntil=n+i*o}else a(e.id,"innerKeyAlreadyOwned. Owned by",t)}function D(e,n){return a(e.id,"locked"),e.state="locked",g.onlock(e.id),e.callback()}function F(e){return function(t){a(e.id,"unlocked"),g.onunlock(e.id),p[e.state]||(e.state="unlocked",T(e.innerKey),e.resolve(t))}}function P(e){return function(t){a(e.id,"unlocked-error"),g.onunlock(),p[e.state]||(T(e.innerKey),e.state="unlocked",e.reject(t))}}if(m===!1){let e=function(){clearTimeout(y);for(const[n,t]of d)for(const o of t.lockRequests)o.state==="locked"&&(a(o.id,"deleting innerKey on unload"),T(o.innerKey))};window.addEventListener("unload",e),window.addEventListener("beforeunload",e)}return function(n,t,o){if(U)return;arguments.length===2&&(o=t,t={}),w++;const K={lockNumber:w,id:c+":"+w,key:n,outerKey:l+n,innerKey:s+n,callback:o,state:"requested",outerKeyAlreadyOwned:0,innerKeyAlreadyOwned:0,waitUntil:0},x=new Promise(function(B,$){K.reject=$,K.resolve=B});let C=!1;return d.size===0&&(C=!0),d.has(n)||d.set(n,{key:n,lockRequests:[]}),d.get(n).lockRequests.push(K),C&&L(),x}}function a(){console.log.apply(console,[""+new Date().getTime(),...arguments])}function H(r){return(""+Math.random()).substr(2)}function Q(){return{onlock(){},onunlock(){},expiring(){}}}const u=Math.random()+"";function I(...r){console.log(new Date().getTime(),"debug: ",...r)}function V(r,l){const s=`_MUT_OUTER_${r}`,i=`_MUT_INNER_${r}`,m=new Date().getTime();function f(){I("lock",u,r),l().finally(()=>{localStorage.removeItem(i),I("unlock",u,r)})}function c(){if(new Date().getTime()-m>5e3)throw localStorage.removeItem(i),Error("time out");localStorage.setItem(s,u),I("setItem",u,s);const d=localStorage.getItem(i);d?(I("get InnerItem",u,i,d),setTimeout(c,5)):(localStorage.setItem(i,u),setTimeout(()=>{const w=localStorage.getItem(s);w===u?f():(I("get OuterItem",u,s,w),setTimeout(()=>{const y=localStorage.getItem(i);y===u?f():(I("get InnerItem",u,i,y),setTimeout(c,5))},50))},5))}c()}G({});const h=localStorage;function W(){let r=h.getItem("numbers");if(console.log("add",new Date().getTime(),r),r){const l=Number(r)+1;h.setItem("numbers",String(l))}else h.setItem("numbers",String(1))}window.addEventListener("storage",function(r){r.key==="trigger"&&(console.log("c2 trigger",new Date().getTime()),E())});function E(){V("number",async()=>{await new Promise(r=>{let l=0;const s=()=>{l++,W(),l<20?s():r(1)};s()})})}function k(){const[r,l]=S.exports.useState(0),[s,i]=S.exports.useState(0);S.exports.useState({}),S.exports.useState({});function m(){let f=window.localStorage.getItem("numbers");l(Number(f))}return S.exports.useEffect(()=>{m()},[]),z(J,{children:[A(b,{onClick:()=>{i(0),window.localStorage.setItem("numbers","0"),m()},children:"reset"}),A(b,{onClick:m,children:"get"}),r,A(b,{onClick:()=>{console.log("c1 trigger",new Date().getTime()),window.localStorage.setItem("trigger",String(Number(window.localStorage.getItem("trigger"))==0?1:0)),E(),i(f=>f+40)},children:"trigger"}),s]})}export{k as default};
